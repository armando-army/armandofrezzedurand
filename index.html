import React, { useEffect, useRef } from "react";
import { Download } from "lucide-react";
import * as THREE from "three";
import { OBJLoader } from "three/examples/jsm/loaders/OBJLoader.js";
import { AsciiEffect } from "three/examples/jsm/effects/AsciiEffect.js";

export default function ArmandoPortfolio() {
  const asciiMountRef = useRef(null);

  useEffect(() => {
    if (!asciiMountRef.current) return;

    // ✅ OBJ RAW correcto (sin /refs/heads/)
    const OBJ_URL =
      "https://raw.githubusercontent.com/armando-army/armandofrezzedurand/main/FRANCO_LowPoly.obj";

    // Scene / Camera
    const scene = new THREE.Scene();
    scene.background = null;

    const camera = new THREE.PerspectiveCamera(
      55,
      asciiMountRef.current.clientWidth / asciiMountRef.current.clientHeight,
      0.1,
      2000
    );
    camera.position.set(0, 1.2, 4.5);

    // WebGL Renderer (base)
    const renderer = new THREE.WebGLRenderer({
      alpha: true,
      antialias: true,
    });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    // ASCII Effect
    const effect = new AsciiEffect(renderer, " .:-=+*#%@", { invert: true });
    effect.domElement.style.color = "#000";
    effect.domElement.style.backgroundColor = "transparent";
    effect.domElement.style.fontFamily =
      'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    effect.domElement.style.fontSize = "10px";
    effect.domElement.style.lineHeight = "10px";
    effect.domElement.style.letterSpacing = "0px";
    effect.domElement.style.userSelect = "none";
    effect.domElement.style.width = "100%";
    effect.domElement.style.height = "100%";

    asciiMountRef.current.appendChild(effect.domElement);

    // Lights
    const key = new THREE.DirectionalLight(0xffffff, 1.1);
    key.position.set(3, 4, 2);
    scene.add(key);

    const fill = new THREE.DirectionalLight(0xffffff, 0.6);
    fill.position.set(-3, 2, 3);
    scene.add(fill);

    const ambient = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambient);

    // Group for OBJ
    const group = new THREE.Group();
    scene.add(group);

    const loader = new OBJLoader();
    loader.load(
      OBJ_URL,
      (obj) => {
        obj.traverse((child) => {
          if (child.isMesh) {
            child.material = new THREE.MeshStandardMaterial({
              color: 0xffffff,
              metalness: 0.0,
              roughness: 1.0,
            });
          }
        });

        // Center + auto-scale
        const box = new THREE.Box3().setFromObject(obj);
        const size = new THREE.Vector3();
        box.getSize(size);
        const center = new THREE.Vector3();
        box.getCenter(center);

        obj.position.sub(center);

        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 2.2 / (maxDim || 1);
        obj.scale.setScalar(scale);

        obj.position.y += 0.1;
        group.add(obj);
      },
      undefined,
      (err) => console.error("Error cargando OBJ:", err)
    );

    // Resize handler
    const setSize = () => {
      const w = asciiMountRef.current.clientWidth;
      const h = asciiMountRef.current.clientHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
      effect.setSize(w, h);
    };

    setSize();
    window.addEventListener("resize", setSize);

    // Animate
    let rafId = 0;
    const animate = () => {
      rafId = requestAnimationFrame(animate);
      group.rotation.y += 0.004; // ✅ giro constante
      group.rotation.x = -0.08;  // ✅ tilt leve para volumen
      effect.render(scene, camera);
    };
    animate();

    return () => {
      window.removeEventListener("resize", setSize);
      cancelAnimationFrame(rafId);

      if (effect.domElement?.parentNode) {
        effect.domElement.parentNode.removeChild(effect.domElement);
      }
      renderer.dispose();
    };
  }, []);

  return (
    <div className="min-h-screen bg-white">
      <header className="fixed top-0 left-0 right-0 z-50 px-6 md:px-16 lg:px-24 py-6 md:py-8 bg-white bg-opacity-95">
        <div className="max-w-7xl mx-auto">
          <h1 className="text-lg md:text-xl font-light tracking-tight">
            Armando Frezze Durand
          </h1>
          <p className="text-xs md:text-sm text-gray-600 font-light">
            Imagen · tecnología · materialidad
          </p>
        </div>
      </header>

      {/* ASCII OBJ HERO */}
      <section className="relative h-screen flex items-center justify-center overflow-hidden">
        <div ref={asciiMountRef} className="absolute inset-0" />
        <div className="relative z-10 text-center px-6">
          <h2 className="text-5xl md:text-7xl lg:text-8xl font-light tracking-tight mb-4">
            FRANCO
          </h2>
          <p className="text-lg md:text-xl text-gray-600 font-light">
            LowPoly OBJ · ASCII render
          </p>
        </div>
      </section>

      {/* PDF button (ejemplo) */}
      <section className="px-6 md:px-16 lg:px-24 py-20 max-w-7xl mx-auto">
        <a
          href="portfolio-escultura.pdf"
          target="_blank"
          rel="noopener noreferrer"
          className="inline-flex items-center gap-3 bg-black text-white px-8 py-4 text-sm uppercase tracking-wider hover:bg-gray-900 transition-colors font-light"
        >
          <Download size={18} />
          Descargar Portfolio – Escultura
        </a>
      </section>

      {/* Contacto */}
      <section className="px-6 md:px-16 lg:px-24 py-20 max-w-7xl mx-auto border-t border-gray-200">
        <div className="text-left space-y-1 text-sm md:text-base text-gray-700 font-light">
          <p>Armando Frezze Durand</p>
          <p>Buenos Aires, Argentina</p>
          <p>
            <a
              href="mailto:armando@dooplerstudio.com.ar"
              className="hover:text-black transition-colors"
            >
              armando@dooplerstudio.com.ar
            </a>
          </p>
          <p>
            <a href="tel:+5491165598444" className="hover:text-black transition-colors">
              +54 9 11 6559 8444
            </a>
          </p>
        </div>
      </section>
    </div>
  );
}
